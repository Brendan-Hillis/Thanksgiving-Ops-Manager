<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanksgiving Ops Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Imports converted to Global Destructuring ---
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Inline Icon Components (Replacing External Dependency) ---
        
        const Icon = ({ children, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" 
                height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                {...props}
            >
                {children}
            </svg>
        );

        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Utensils = (props) => <Icon {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></Icon>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const ChefHat = (props) => <Icon {...props}><path d="M17 21a1 1 0 0 0 1-1v-5.35c0-.457.316-.844.727-1.041a4 4 0 0 0-2.134-7.589 5 5 0 0 0-9.186 0 4 4 0 0 0-2.134 7.588c.411.198.727.585.727 1.041V20a1 1 0 0 0 1 1h10z"/><path d="M6 17h12"/></Icon>;
        const Calendar = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const CheckCircle2 = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></Icon>;
        const ListChecks = (props) => <Icon {...props}><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;

        // --- Helper Functions ---

        const minutesToTime = (totalMinutes) => {
            let minutes = totalMinutes % 60;
            let hours = Math.floor(totalMinutes / 60);
            const period = hours >= 12 ? 'PM' : 'AM';
            
            if (hours > 12) hours -= 12;
            if (hours === 0) hours = 12; // Midnight/Noon adjustment
            
            // Handle negative or previous day (simplified for single day view)
            if (totalMinutes < 0) return `Day Prior ${12 + hours}:${minutes.toString().padStart(2, '0')} ${period}`;
            
            return `${hours}:${minutes.toString().padStart(2, '0')} ${period}`;
        };

        const parseTimeInput = (timeStr) => {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        };

        // --- Main Component ---

        function ThanksgivingPlanner() {
            const [dinnerTimeStr, setDinnerTimeStr] = useState("15:00"); // 3:00 PM
            const [view, setView] = useState('gantt'); 
            const fileInputRef = useRef(null);
            
            // State initialized to empty arrays. 
            // We trust the useEffect to fetch data if localStorage is empty.
            
            const [dishes, setDishes] = useState(() => {
                const saved = localStorage.getItem('thanksgiving_dishes_v2');
                return saved ? JSON.parse(saved) : [];
            });

            const [prepList, setPrepList] = useState(() => {
                const saved = localStorage.getItem('thanksgiving_prep_v2');
                return saved ? JSON.parse(saved) : [];
            });

            const [resources, setResources] = useState(() => {
                const saved = localStorage.getItem('thanksgiving_resources_v2');
                return saved ? JSON.parse(saved) : [];
            });

            const [newDish, setNewDish] = useState({
                name: '',
                prepMinutes: 15,
                cookMinutes: 30,
                restMinutes: 0,
                resource: '', // Will default to first available or empty
                temp: 350
            });

            const [newPrepItem, setNewPrepItem] = useState({ day: 'Wednesday', task: '' });
            const [newResourceName, setNewResourceName] = useState('');
            const [isManagingResources, setIsManagingResources] = useState(false);

            // Fetch Default Data on Mount
            useEffect(() => {
                const hasLocalData = localStorage.getItem('thanksgiving_dishes_v2');
                
                // Only fetch if we have no local data to prevent overwriting work
                if (!hasLocalData) {
                    fetchDefaultPlan();
                }
            }, []);
            
            // Ensure newDish has a valid resource default when resources change
            useEffect(() => {
                if (resources.length > 0 && !newDish.resource) {
                    setNewDish(prev => ({ ...prev, resource: resources[0] }));
                }
            }, [resources]);

            const fetchDefaultPlan = async () => {
                try {
                    const response = await fetch('./default-plan.json');
                    if (!response.ok) throw new Error('No default plan file found');
                    
                    const data = await response.json();
                    
                    if (data.dishes) setDishes(data.dishes);
                    if (data.prepList) setPrepList(data.prepList);
                    if (data.resources) setResources(data.resources);
                    
                } catch (error) {
                    console.log('Could not load default plan:', error);
                    // If fetch fails, we just start with empty state, which is fine.
                }
            };

            // Persist to localStorage
            useEffect(() => {
                localStorage.setItem('thanksgiving_dishes_v2', JSON.stringify(dishes));
            }, [dishes]);

            useEffect(() => {
                localStorage.setItem('thanksgiving_prep_v2', JSON.stringify(prepList));
            }, [prepList]);

            useEffect(() => {
                localStorage.setItem('thanksgiving_resources_v2', JSON.stringify(resources));
            }, [resources]);

            // Calculate timelines
            const scheduleData = useMemo(() => {
                const dinnerMinutes = parseTimeInput(dinnerTimeStr);
                
                const processedDishes = dishes.map(dish => {
                    const totalDuration = dish.prepMinutes + dish.cookMinutes + dish.restMinutes;
                    
                    const finishTime = dinnerMinutes; 
                    const restStartTime = finishTime - dish.restMinutes;
                    const cookStartTime = restStartTime - dish.cookMinutes;
                    const prepStartTime = cookStartTime - dish.prepMinutes;
                    
                    return {
                        ...dish,
                        totalDuration,
                        times: {
                            start: prepStartTime,
                            cook: cookStartTime,
                            rest: restStartTime,
                            finish: finishTime
                        }
                    };
                });

                const sortedDishes = [...processedDishes].sort((a, b) => a.times.start - b.times.start);
                
                const earliestStart = Math.min(...processedDishes.map(d => d.times.start));
                const range = dinnerMinutes - earliestStart;

                return { processedDishes, sortedDishes, earliestStart, range, dinnerMinutes };
            }, [dishes, dinnerTimeStr]);

            // Conflict Detection
            const conflicts = useMemo(() => {
                const alerts = [];
                // Group dishes by resource
                const dishesByResource = {};
                scheduleData.processedDishes.forEach(d => {
                    if (!d.resource) return; // Skip if no resource assigned
                    if (!dishesByResource[d.resource]) dishesByResource[d.resource] = [];
                    dishesByResource[d.resource].push(d);
                });

                Object.keys(dishesByResource).forEach(resource => {
                    // Skip infinite capacity resources
                    if (['Counter', 'Fridge'].includes(resource)) return;

                    const dishes = dishesByResource[resource];
                    for (let i = 0; i < dishes.length; i++) {
                        for (let j = i + 1; j < dishes.length; j++) {
                            const dishA = dishes[i];
                            const dishB = dishes[j];
                            
                            // Overlap Check
                            const startA = dishA.times.cook;
                            const endA = dishA.times.rest; // Cooking ends at rest start
                            const startB = dishB.times.cook;
                            const endB = dishB.times.rest;

                            if (startA < endB && endA > startB) {
                                // If it's an Oven, check temps
                                if (resource.includes('Oven')) {
                                    if (dishA.temp !== dishB.temp) {
                                        alerts.push({
                                            id: `${dishA.id}-${dishB.id}`,
                                            message: `Temperature Conflict on ${resource}! ${dishA.name} (${dishA.temp}Â°F) vs ${dishB.name} (${dishB.temp}Â°F).`,
                                            severity: 'high'
                                        });
                                    } else {
                                        alerts.push({
                                            id: `${dishA.id}-${dishB.id}`,
                                            message: `Capacity Warning (${resource}): ${dishA.name} and ${dishB.name} overlap. Check rack space.`,
                                            severity: 'medium'
                                        });
                                    }
                                } else {
                                    // Generic resource conflict (e.g. Deep Fryer double booking)
                                    alerts.push({
                                        id: `${dishA.id}-${dishB.id}`,
                                        message: `Resource Conflict (${resource}): ${dishA.name} and ${dishB.name} need the device at the same time.`,
                                        severity: 'high'
                                    });
                                }
                            }
                        }
                    }
                });
                return alerts;
            }, [scheduleData]);

            // Generate Run Sheet
            const runSheet = useMemo(() => {
                const actions = [];
                scheduleData.processedDishes.forEach(dish => {
                    if (dish.prepMinutes > 0) {
                        actions.push({ time: dish.times.start, action: `Start Prepping ${dish.name}`, type: 'prep', dishName: dish.name });
                    }
                    if (dish.cookMinutes > 0) {
                        actions.push({ 
                            time: dish.times.cook, 
                            action: `${dish.resource && dish.resource.includes('Oven') ? `Put ${dish.name} in ${dish.resource}` : `Start Cooking/Warming ${dish.name} (${dish.resource || 'Unknown'})`}`, 
                            type: 'cook',
                            dishName: dish.name
                        });
                    }
                    if (dish.restMinutes > 0) {
                        actions.push({ time: dish.times.rest, action: `Remove ${dish.name} & Rest/Hold`, type: 'rest', dishName: dish.name });
                    }
                });
                
                actions.push({ time: scheduleData.dinnerMinutes, action: "SERVE DINNER ðŸ¦ƒ", type: 'serve', dishName: 'Everyone' });

                return actions.sort((a, b) => a.time - b.time);
            }, [scheduleData]);

            const addDish = () => {
                if (!newDish.name) return;
                setDishes([...dishes, { ...newDish, id: Date.now(), color: 'bg-slate-500' }]);
                setNewDish({ name: '', prepMinutes: 15, cookMinutes: 30, restMinutes: 0, resource: resources[0] || '', temp: 350 });
            };

            const removeDish = (id) => {
                setDishes(dishes.filter(d => d.id !== id));
            };

            const togglePrepItem = (id) => {
                setPrepList(prepList.map(item => item.id === id ? { ...item, done: !item.done } : item));
            };
            
            const addPrepItem = () => {
                if(!newPrepItem.task) return;
                setPrepList([...prepList, { id: Date.now(), ...newPrepItem, done: false }]);
                setNewPrepItem({ ...newPrepItem, task: '' });
            };

            const removePrepItem = (id) => {
                setPrepList(prepList.filter(item => item.id !== id));
            };

            const addResource = () => {
                if(!newResourceName) return;
                if(resources.includes(newResourceName)) return;
                setResources([...resources, newResourceName]);
                setNewResourceName('');
            };

            const removeResource = (rToRemove) => {
                if(confirm(`Are you sure you want to remove ${rToRemove}? Existing dishes using it will keep the data but may show warnings.`)) {
                    setResources(resources.filter(r => r !== rToRemove));
                }
            };

            // --- Export / Import Handlers ---

            const handleExport = () => {
                const data = {
                    dishes,
                    prepList,
                    resources,
                    version: 1,
                    savedAt: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `thanksgiving-plan-${new Date().getFullYear()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.dishes && Array.isArray(data.dishes)) setDishes(data.dishes);
                        if (data.prepList && Array.isArray(data.prepList)) setPrepList(data.prepList);
                        if (data.resources && Array.isArray(data.resources)) setResources(data.resources);
                        alert('Plan loaded successfully! Timeline, Checklist, and Inventory have been updated.');
                    } catch (error) {
                        alert('Error loading file. Please ensure it is a valid Thanksgiving Plan JSON file.');
                        console.error(error);
                    }
                    // Reset input so same file can be loaded again if needed
                    event.target.value = null;
                };
                reader.readAsText(file);
            };

            const handleResetToDefaults = async () => {
                if(confirm("Are you sure? This will overwrite your current plan with the default-plan.json from the server.")) {
                     await fetchDefaultPlan();
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-12">
                    {/* Header */}
                    <header className="bg-orange-700 text-white p-6 shadow-lg">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold flex items-center gap-3">
                                    <ChefHat className="h-8 w-8" />
                                    Thanksgiving Ops Manager
                                </h1>
                                <p className="text-orange-100 opacity-90 text-sm mt-1">Optimize your holiday critical path.</p>
                            </div>
                            
                            <div className="mt-4 md:mt-0 bg-orange-800 p-3 rounded-lg flex items-center gap-4 border border-orange-600">
                                <label className="text-sm font-semibold uppercase tracking-wider text-orange-200">Target Dinner Time:</label>
                                <input 
                                    type="time" 
                                    value={dinnerTimeStr} 
                                    onChange={(e) => setDinnerTimeStr(e.target.value)}
                                    className="bg-white text-slate-900 px-3 py-1 rounded font-bold text-lg focus:outline-none focus:ring-2 focus:ring-orange-400"
                                />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
                        
                        {/* Navigation Tabs */}
                        <div className="flex gap-2 border-b border-slate-200 pb-1 overflow-x-auto">
                            <button 
                                onClick={() => setView('gantt')}
                                className={`px-4 py-2 rounded-t-lg font-medium transition-colors whitespace-nowrap ${view === 'gantt' ? 'bg-white text-orange-700 border-x border-t border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                <Calendar className="inline w-4 h-4 mr-2" />
                                Timeline (Day Of)
                            </button>
                            <button 
                                onClick={() => setView('prep')}
                                className={`px-4 py-2 rounded-t-lg font-medium transition-colors whitespace-nowrap ${view === 'prep' ? 'bg-white text-orange-700 border-x border-t border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                <ListChecks className="inline w-4 h-4 mr-2" />
                                Prep Days (Tue/Wed)
                            </button>
                            <button 
                                onClick={() => setView('list')}
                                className={`px-4 py-2 rounded-t-lg font-medium transition-colors whitespace-nowrap ${view === 'list' ? 'bg-white text-orange-700 border-x border-t border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                <CheckCircle2 className="inline w-4 h-4 mr-2" />
                                Run Sheet
                            </button>
                            <button 
                                onClick={() => setView('input')}
                                className={`px-4 py-2 rounded-t-lg font-medium transition-colors whitespace-nowrap ${view === 'input' ? 'bg-white text-orange-700 border-x border-t border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                <Utensils className="inline w-4 h-4 mr-2" />
                                Manage Dishes
                            </button>
                        </div>

                        {/* Conflict Alerts */}
                        {conflicts.length > 0 && (
                            <div className="space-y-2">
                                {conflicts.map(conflict => (
                                    <div key={conflict.id} className={`p-4 rounded-md flex items-start gap-3 ${conflict.severity === 'high' ? 'bg-red-100 text-red-800 border-l-4 border-red-500' : 'bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500'}`}>
                                        <AlertTriangle className="h-5 w-5 mt-0.5 shrink-0" />
                                        <div>
                                            <h4 className="font-bold">{conflict.severity === 'high' ? 'Critical Conflict' : 'Resource Warning'}</h4>
                                            <p className="text-sm">{conflict.message}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* View: Gantt Chart */}
                        {view === 'gantt' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-4">
                                <h2 className="text-xl font-bold mb-6 text-slate-800">Production Schedule (Thursday)</h2>
                                
                                <div className="overflow-x-auto pb-4">
                                    <div className="min-w-[800px]">
                                        {/* Time Axis (Simplified) */}
                                        <div className="flex border-b border-slate-200 pb-2 mb-4 text-xs text-slate-400">
                                            <div className="w-1/4">Dish</div>
                                            <div className="w-3/4 flex justify-between px-2">
                                                <span>Start Prep</span>
                                                <span className="text-center">Cooking</span>
                                                <span className="text-right">Dinner ({dinnerTimeStr})</span>
                                            </div>
                                        </div>

                                        <div className="space-y-6">
                                            {scheduleData.sortedDishes.map((dish) => {
                                                const totalProjectMinutes = scheduleData.range || 1; 
                                                const startOffset = dish.times.start - scheduleData.earliestStart;
                                                
                                                const leftPct = (startOffset / totalProjectMinutes) * 75; 
                                                const prepWidth = (dish.prepMinutes / totalProjectMinutes) * 75;
                                                const cookWidth = (dish.cookMinutes / totalProjectMinutes) * 75;
                                                const restWidth = (dish.restMinutes / totalProjectMinutes) * 75;

                                                return (
                                                    <div key={dish.id} className="group">
                                                        <div className="flex items-center mb-1">
                                                            <div className="w-1/4 pr-4">
                                                                <div className="font-bold text-slate-800 truncate" title={dish.name}>{dish.name}</div>
                                                                <div className="text-xs text-slate-500 flex gap-2">
                                                                    <span>{dish.resource} {dish.resource && dish.resource.includes('Oven') && `@ ${dish.temp}Â°F`}</span>
                                                                </div>
                                                            </div>
                                                            <div className="w-3/4 relative h-8 bg-slate-100 rounded-full flex overflow-hidden">
                                                                {/* Spacer */}
                                                                <div style={{ width: `${leftPct}%` }} className="h-full bg-transparent shrink-0"></div>
                                                                
                                                                {/* Prep Block */}
                                                                {dish.prepMinutes > 0 && (
                                                                    <div style={{ width: `${Math.max(prepWidth, 1)}%` }} className="h-full bg-blue-400 shrink-0 flex items-center justify-center group/item relative cursor-help">
                                                                        <span className="text-[10px] text-white font-bold truncate px-1">Prep</span>
                                                                        <div className="absolute bottom-full mb-1 hidden group-hover/item:block bg-slate-800 text-white text-xs p-1 rounded z-10 whitespace-nowrap shadow-xl">
                                                                            {minutesToTime(dish.times.start)} - Prep ({dish.prepMinutes}m)
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* Cook Block */}
                                                                {dish.cookMinutes > 0 && (
                                                                    <div style={{ width: `${Math.max(cookWidth, 1)}%` }} className={`h-full ${dish.resource && dish.resource.includes('Oven') ? 'bg-orange-500' : 'bg-red-500'} shrink-0 flex items-center justify-center group/item relative cursor-help`}>
                                                                        <span className="text-[10px] text-white font-bold truncate px-1">Cook</span>
                                                                        <div className="absolute bottom-full mb-1 hidden group-hover/item:block bg-slate-800 text-white text-xs p-1 rounded z-10 whitespace-nowrap shadow-xl">
                                                                            {minutesToTime(dish.times.cook)} - Cook ({dish.cookMinutes}m)
                                                                        </div>
                                                                    </div>
                                                                )}

                                                                {/* Rest Block */}
                                                                {dish.restMinutes > 0 && (
                                                                    <div style={{ width: `${Math.max(restWidth, 1)}%` }} className="h-full bg-emerald-400 shrink-0 flex items-center justify-center group/item relative cursor-help">
                                                                        <span className="text-[10px] text-white font-bold truncate px-1">Rest</span>
                                                                        <div className="absolute bottom-full mb-1 hidden group-hover/item:block bg-slate-800 text-white text-xs p-1 rounded z-10 whitespace-nowrap shadow-xl">
                                                                            {minutesToTime(dish.times.rest)} - Rest ({dish.restMinutes}m)
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="w-full flex justify-end text-xs text-slate-400 border-b border-slate-100 pb-2">
                                                            Start at: <span className="font-mono text-slate-600 ml-1">{minutesToTime(dish.times.start)}</span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        
                                        {/* Legend */}
                                        <div className="mt-8 flex gap-4 text-xs justify-end text-slate-500">
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-blue-400 rounded"></div>Prep</div>
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-orange-500 rounded"></div>Cook (Oven)</div>
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-red-500 rounded"></div>Cook (Other)</div>
                                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-emerald-400 rounded"></div>Rest</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* View: Prep List */}
                        {view === 'prep' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h2 className="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2">
                                    <ListChecks className="w-6 h-6 text-orange-600" />
                                    Prep Ahead Checklist
                                </h2>

                                <div className="mb-6 grid grid-cols-1 md:grid-cols-4 gap-2">
                                    <select 
                                        className="border border-slate-300 rounded p-2"
                                        value={newPrepItem.day}
                                        onChange={(e) => setNewPrepItem({...newPrepItem, day: e.target.value})}
                                    >
                                        <option>Monday</option>
                                        <option>Tuesday</option>
                                        <option>Wednesday</option>
                                        <option>Thursday Morning</option>
                                    </select>
                                    <input 
                                        type="text" 
                                        className="border border-slate-300 rounded p-2 md:col-span-2" 
                                        placeholder="Add new task..." 
                                        value={newPrepItem.task}
                                        onChange={(e) => setNewPrepItem({...newPrepItem, task: e.target.value})}
                                        onKeyPress={(e) => e.key === 'Enter' && addPrepItem()}
                                    />
                                    <button onClick={addPrepItem} className="bg-slate-800 text-white rounded p-2 font-bold">Add Task</button>
                                </div>

                                <div className="space-y-6">
                                    {['Tuesday', 'Wednesday', 'Thursday Morning'].map(day => {
                                        const dayItems = prepList.filter(item => item.day === day);
                                        if (dayItems.length === 0) return null;
                                        return (
                                            <div key={day}>
                                                <h3 className="font-bold text-lg text-slate-500 border-b border-slate-200 mb-3 pb-1">{day}</h3>
                                                <div className="space-y-2">
                                                    {dayItems.map(item => (
                                                        <div key={item.id} className="flex items-start gap-3 group">
                                                            <button 
                                                                onClick={() => togglePrepItem(item.id)}
                                                                className={`mt-1 w-5 h-5 rounded border flex items-center justify-center shrink-0 transition-colors ${item.done ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 hover:border-orange-500'}`}
                                                            >
                                                                {item.done && <CheckCircle2 className="w-3.5 h-3.5" />}
                                                            </button>
                                                            <div className="flex-1 flex justify-between items-start">
                                                                <span className={item.done ? 'text-slate-400 line-through' : 'text-slate-800'}>{item.task}</span>
                                                                <button onClick={() => removePrepItem(item.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 className="w-4 h-4" /></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* View: Run Sheet */}
                        {view === 'list' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h2 className="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2">
                                    <Clock className="w-6 h-6 text-orange-600" />
                                    Master Run Sheet (Thursday)
                                </h2>
                                <div className="relative border-l-2 border-slate-200 ml-3 space-y-8 pb-4">
                                    {runSheet.map((item, idx) => (
                                        <div key={idx} className="relative pl-8 group">
                                            <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 border-white ${
                                                item.type === 'serve' ? 'bg-orange-600 w-5 h-5 -left-[11px]' :
                                                item.type === 'prep' ? 'bg-blue-400' :
                                                item.type === 'rest' ? 'bg-emerald-400' : 'bg-red-500'
                                            }`}></div>
                                            
                                            <div className="flex flex-col sm:flex-row sm:items-baseline gap-2">
                                                <span className="font-mono font-bold text-lg text-slate-700 min-w-[100px]">{minutesToTime(item.time)}</span>
                                                <div className="flex-1">
                                                    <span className={`font-bold text-lg ${item.type === 'serve' ? 'text-orange-700 uppercase tracking-widest' : 'text-slate-800'}`}>
                                                        {item.action}
                                                    </span>
                                                    {item.type !== 'serve' && (
                                                        <div className="text-sm text-slate-500 mt-1">
                                                            Target: {item.dishName}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* View: Input Management */}
                        {view === 'input' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {/* Left Column: Add Form OR Resource Manager */}
                                <div className="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-fit">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg flex items-center gap-2">
                                            {isManagingResources ? <Settings className="w-5 h-5" /> : <Plus className="w-5 h-5" />} 
                                            {isManagingResources ? 'Kitchen Inventory' : 'Add New Dish'}
                                        </h3>
                                        <button 
                                            onClick={() => setIsManagingResources(!isManagingResources)}
                                            className="text-xs font-semibold text-orange-600 hover:text-orange-800 underline"
                                        >
                                            {isManagingResources ? 'Back to Add Dish' : 'Manage Inventory'}
                                        </button>
                                    </div>

                                    {!isManagingResources ? (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Dish Name</label>
                                                <input 
                                                    type="text" 
                                                    value={newDish.name} 
                                                    onChange={e => setNewDish({...newDish, name: e.target.value})}
                                                    placeholder="e.g. Cornbread"
                                                    className="w-full border border-slate-300 rounded p-2 focus:ring-2 focus:ring-orange-200 outline-none"
                                                />
                                            </div>

                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Prep (min)</label>
                                                    <input 
                                                        type="number" 
                                                        value={newDish.prepMinutes} 
                                                        onChange={e => setNewDish({...newDish, prepMinutes: parseInt(e.target.value) || 0})}
                                                        className="w-full border border-slate-300 rounded p-2"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Cook (min)</label>
                                                    <input 
                                                        type="number" 
                                                        value={newDish.cookMinutes} 
                                                        onChange={e => setNewDish({...newDish, cookMinutes: parseInt(e.target.value) || 0})}
                                                        className="w-full border border-slate-300 rounded p-2"
                                                    />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Rest (min)</label>
                                                    <input 
                                                        type="number" 
                                                        value={newDish.restMinutes} 
                                                        onChange={e => setNewDish({...newDish, restMinutes: parseInt(e.target.value) || 0})}
                                                        className="w-full border border-slate-300 rounded p-2"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Resource</label>
                                                    <select 
                                                        value={newDish.resource} 
                                                        onChange={e => setNewDish({...newDish, resource: e.target.value})}
                                                        className="w-full border border-slate-300 rounded p-2 bg-white"
                                                    >
                                                        {resources.map(r => <option key={r} value={r}>{r}</option>)}
                                                    </select>
                                                </div>
                                            </div>

                                            {newDish.resource && newDish.resource.includes('Oven') && (
                                                <div>
                                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Oven Temp (Â°F)</label>
                                                    <input 
                                                        type="number" 
                                                        value={newDish.temp} 
                                                        step="25"
                                                        onChange={e => setNewDish({...newDish, temp: parseInt(e.target.value) || 0})}
                                                        className="w-full border border-slate-300 rounded p-2"
                                                    />
                                                </div>
                                            )}

                                            <button 
                                                onClick={addDish}
                                                className="w-full bg-orange-600 text-white font-bold py-3 rounded hover:bg-orange-700 transition-colors flex justify-center items-center gap-2 mt-2"
                                            >
                                                Add to Plan
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="bg-orange-50 p-3 rounded text-xs text-orange-800">
                                                Add appliances here to select them for your dishes. For automatic temperature conflicts, please include "Oven" in the name.
                                            </div>
                                            
                                            <div className="flex gap-2">
                                                <input 
                                                    type="text"
                                                    value={newResourceName}
                                                    onChange={e => setNewResourceName(e.target.value)}
                                                    placeholder="e.g. Air Fryer"
                                                    className="w-full border border-slate-300 rounded p-2"
                                                />
                                                <button 
                                                    onClick={addResource}
                                                    className="bg-slate-800 text-white px-3 rounded font-bold"
                                                >
                                                    Add
                                                </button>
                                            </div>

                                            <div className="space-y-2 max-h-[300px] overflow-y-auto pr-1">
                                                {resources.map(r => (
                                                    <div key={r} className="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-200">
                                                        <span className="text-sm font-medium">{r}</span>
                                                        {!['Counter', 'Fridge'].includes(r) && (
                                                            <button 
                                                                onClick={() => removeResource(r)} 
                                                                className="text-slate-400 hover:text-red-500"
                                                            >
                                                                <Trash2 className="w-4 h-4" />
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Data Management Section */}
                                    <div className="mt-8 pt-6 border-t border-slate-200">
                                        <h4 className="font-bold text-slate-600 mb-3 text-sm uppercase">Data Management</h4>
                                        <div className="flex gap-2 flex-col">
                                            <button 
                                                onClick={handleExport}
                                                className="w-full border border-slate-300 text-slate-700 font-semibold py-2 rounded hover:bg-slate-50 transition-colors flex justify-center items-center gap-2 text-sm"
                                            >
                                                <Download className="w-4 h-4" /> Save Plan to File
                                            </button>
                                            
                                            <div className="relative">
                                                <input 
                                                    type="file" 
                                                    accept=".json" 
                                                    ref={fileInputRef}
                                                    onChange={handleImport}
                                                    className="hidden" 
                                                />
                                                <button 
                                                    onClick={() => fileInputRef.current?.click()}
                                                    className="w-full border border-slate-300 text-slate-700 font-semibold py-2 rounded hover:bg-slate-50 transition-colors flex justify-center items-center gap-2 text-sm"
                                                >
                                                    <Upload className="w-4 h-4" /> Load Plan from File
                                                </button>
                                            </div>

                                            <button 
                                                onClick={handleResetToDefaults}
                                                className="w-full border border-slate-300 text-slate-500 hover:text-orange-700 font-semibold py-2 rounded hover:bg-slate-50 transition-colors flex justify-center items-center gap-2 text-sm"
                                            >
                                                <RefreshCw className="w-4 h-4" /> Reset to Repo Defaults
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* List */}
                                <div className="md:col-span-2 space-y-4">
                                    {dishes.map(dish => (
                                        <div key={dish.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group">
                                            <div>
                                                <h4 className="font-bold text-lg text-slate-800">{dish.name}</h4>
                                                <div className="text-sm text-slate-500 mt-1 flex gap-4 flex-wrap">
                                                    <span className="flex items-center gap-1"><Utensils className="w-3 h-3" /> {dish.resource} {dish.resource && dish.resource.includes('Oven') && `(${dish.temp}Â°F)`}</span>
                                                    <span>Prep: {dish.prepMinutes}m</span>
                                                    <span>Cook: {dish.cookMinutes}m</span>
                                                    <span>Rest: {dish.restMinutes}m</span>
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => removeDish(dish.id)}
                                                className="text-slate-300 hover:text-red-500 transition-colors p-2"
                                            >
                                                <Trash2 className="w-5 h-5" />
                                            </button>
                                        </div>
                                    ))}
                                    {dishes.length === 0 && (
                                        <div className="text-center py-12 text-slate-400 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300">
                                            <p>No dishes planned yet. <br/><span className="text-xs">Checking for defaults...</span></p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </main>
                    <footer className="max-w-6xl mx-auto p-6 text-center text-slate-400 text-sm">
                        <p>All times calculated backwards from dinner time. Data saved to browser storage.</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ThanksgivingPlanner />);
    </script>
</body>
</html>
