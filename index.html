import React, { useState, useEffect, useMemo } from 'react';
import { 
  Clock, 
  Utensils, 
  AlertTriangle, 
  Plus, 
  Trash2, 
  ChefHat, 
  Calendar,
  Thermometer,
  ArrowRight,
  CheckCircle2
} from 'lucide-react';

// --- Default Data & Types ---

const INITIAL_DISHES = [
  { id: 1, name: 'Roast Turkey (20lb)', prepMinutes: 45, cookMinutes: 240, restMinutes: 45, resource: 'Oven', temp: 325, color: 'bg-amber-500' },
  { id: 2, name: 'Deep Fried Turkey', prepMinutes: 60, cookMinutes: 45, restMinutes: 30, resource: 'Deep Fryer', temp: 350, color: 'bg-red-600' },
  { id: 3, name: 'Mashed Potatoes', prepMinutes: 20, cookMinutes: 25, restMinutes: 0, resource: 'Stovetop', temp: 0, color: 'bg-yellow-200' },
  { id: 4, name: 'Green Bean Casserole', prepMinutes: 15, cookMinutes: 30, restMinutes: 5, resource: 'Oven', temp: 350, color: 'bg-green-600' },
  { id: 5, name: 'Apple Sauce', prepMinutes: 15, cookMinutes: 0, restMinutes: 120, resource: 'Fridge', temp: 0, color: 'bg-red-200' },
  { id: 6, name: 'Gravy', prepMinutes: 5, cookMinutes: 15, restMinutes: 0, resource: 'Stovetop', temp: 0, color: 'bg-amber-800' },
];

const RESOURCES = ['Oven', 'Stovetop', 'Deep Fryer', 'Microwave', 'Counter', 'Fridge', 'Smoker'];

// --- Helper Functions ---

const minutesToTime = (totalMinutes) => {
  let minutes = totalMinutes % 60;
  let hours = Math.floor(totalMinutes / 60);
  const period = hours >= 12 ? 'PM' : 'AM';
  
  if (hours > 12) hours -= 12;
  if (hours === 0) hours = 12; // Midnight/Noon adjustment
  
  // Handle negative or previous day (simplified for single day view)
  if (totalMinutes < 0) return `Day Prior ${12 + hours}:${minutes.toString().padStart(2, '0')} ${period}`;
  
  return `${hours}:${minutes.toString().padStart(2, '0')} ${period}`;
};

const parseTimeInput = (timeStr) => {
  const [hours, minutes] = timeStr.split(':').map(Number);
  return hours * 60 + minutes;
};

// --- Components ---

export default function ThanksgivingPlanner() {
  const [dinnerTimeStr, setDinnerTimeStr] = useState("15:00"); // 3:00 PM
  const [dishes, setDishes] = useState(INITIAL_DISHES);
  const [view, setView] = useState('gantt'); // 'gantt' or 'list' or 'input'
  const [newDish, setNewDish] = useState({
    name: '',
    prepMinutes: 15,
    cookMinutes: 30,
    restMinutes: 0,
    resource: 'Oven',
    temp: 350
  });

  // Calculate timelines
  const scheduleData = useMemo(() => {
    const dinnerMinutes = parseTimeInput(dinnerTimeStr);
    
    // Sort logic: We want everything ready exactly at dinner time
    // Start = Dinner - Rest - Cook - Prep
    
    const processedDishes = dishes.map(dish => {
      const totalDuration = dish.prepMinutes + dish.cookMinutes + dish.restMinutes;
      
      const finishTime = dinnerMinutes; // Ideally ready right at dinner
      const restStartTime = finishTime - dish.restMinutes;
      const cookStartTime = restStartTime - dish.cookMinutes;
      const prepStartTime = cookStartTime - dish.prepMinutes;
      
      return {
        ...dish,
        totalDuration,
        times: {
          start: prepStartTime,
          cook: cookStartTime,
          rest: restStartTime,
          finish: finishTime
        }
      };
    });

    // Sort by earliest start time for the Gantt view
    const sortedDishes = [...processedDishes].sort((a, b) => a.times.start - b.times.start);
    
    // Calculate global start/end for scaling the chart
    const earliestStart = Math.min(...processedDishes.map(d => d.times.start));
    const range = dinnerMinutes - earliestStart;

    return { processedDishes, sortedDishes, earliestStart, range, dinnerMinutes };
  }, [dishes, dinnerTimeStr]);

  // Conflict Detection (Oven Overlap)
  const conflicts = useMemo(() => {
    const ovenDishes = scheduleData.processedDishes.filter(d => d.resource === 'Oven');
    const alerts = [];

    for (let i = 0; i < ovenDishes.length; i++) {
      for (let j = i + 1; j < ovenDishes.length; j++) {
        const dishA = ovenDishes[i];
        const dishB = ovenDishes[j];

        // Check cook time overlap (ignoring prep and rest for oven conflicts)
        const startA = dishA.times.cook;
        const endA = dishA.times.rest; // Cook ends when rest starts
        const startB = dishB.times.cook;
        const endB = dishB.times.rest;

        if (startA < endB && endA > startB) {
          // They overlap
          if (dishA.temp !== dishB.temp) {
            alerts.push({
              id: `${dishA.id}-${dishB.id}`,
              message: `Temperature Conflict! ${dishA.name} needs ${dishA.temp}Â°F but overlaps with ${dishB.name} (${dishB.temp}Â°F).`,
              severity: 'high'
            });
          } else {
            alerts.push({
              id: `${dishA.id}-${dishB.id}`,
              message: `Capacity Warning: ${dishA.name} and ${dishB.name} are in the oven at the same time. Ensure enough rack space.`,
              severity: 'medium'
            });
          }
        }
      }
    }
    return alerts;
  }, [scheduleData]);

  // Generate Run Sheet (Chronological List of Actions)
  const runSheet = useMemo(() => {
    const actions = [];
    scheduleData.processedDishes.forEach(dish => {
      if (dish.prepMinutes > 0) {
        actions.push({ time: dish.times.start, action: `Start Prepping ${dish.name}`, type: 'prep', dishName: dish.name });
      }
      if (dish.cookMinutes > 0) {
        actions.push({ 
          time: dish.times.cook, 
          action: `${dish.resource === 'Oven' ? `Put ${dish.name} in Oven` : `Start Cooking ${dish.name}`}`, 
          type: 'cook',
          dishName: dish.name
        });
      }
      if (dish.restMinutes > 0) {
        actions.push({ time: dish.times.rest, action: `Remove ${dish.name} & Rest/Chill`, type: 'rest', dishName: dish.name });
      }
      if (dish.resource === 'Oven' && dish.cookMinutes > 0) {
         // Add preheat warning 15 mins before first item
         // Note: Logic omitted for brevity to keep single file simple, relying on cook start
      }
    });
    
    // Add Serving Time
    actions.push({ time: scheduleData.dinnerMinutes, action: "SERVE DINNER ðŸ¦ƒ", type: 'serve', dishName: 'Everyone' });

    return actions.sort((a, b) => a.time - b.time);
  }, [scheduleData]);

  const addDish = () => {
    if (!newDish.name) return;
    setDishes([...dishes, { ...newDish, id: Date.now(), color: 'bg-slate-500' }]);
    setNewDish({ name: '', prepMinutes: 15, cookMinutes: 30, restMinutes: 0, resource: 'Oven', temp: 350 });
  };

  const removeDish = (id) => {
    setDishes(dishes.filter(d => d.id !== id));
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans">
      {/* Header */}
      <header className="bg-orange-700 text-white p-6 shadow-lg">
        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <ChefHat className="h-8 w-8" />
              Thanksgiving Ops Manager
            </h1>
            <p className="text-orange-100 opacity-90 text-sm mt-1">Optimize your holiday critical path.</p>
          </div>
          
          <div className="mt-4 md:mt-0 bg-orange-800 p-3 rounded-lg flex items-center gap-4 border border-orange-600">
            <label className="text-sm font-semibold uppercase tracking-wider text-orange-200">Target Dinner Time:</label>
            <input 
              type="time" 
              value={dinnerTimeStr} 
              onChange={(e) => setDinnerTimeStr(e.target.value)}
              className="bg-white text-slate-900 px-3 py-1 rounded font-bold text-lg focus:outline-none focus:ring-2 focus:ring-orange-400"
            />
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
        
        {/* Navigation Tabs */}
        <div className="flex gap-2 border-b border-slate-200 pb-1">
          <button 
            onClick={() => setView('gantt')}
            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${view === 'gantt' ? 'bg-white text-orange-700 border-x border-t border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
          >
            <Calendar className="inline w-4 h-4 mr-2" />
            Timeline (Gantt)
          </button>
          <button 
            onClick={() => setView('list')}
            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${view === 'list' ? 'bg-white text-orange-700 border-x border-t border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
          >
            <CheckCircle2 className="inline w-4 h-4 mr-2" />
            Run Sheet
          </button>
          <button 
            onClick={() => setView('input')}
            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${view === 'input' ? 'bg-white text-orange-700 border-x border-t border-slate-200' : 'text-slate-500 hover:text-slate-700'}`}
          >
            <Utensils className="inline w-4 h-4 mr-2" />
            Manage Dishes
          </button>
        </div>

        {/* Conflict Alerts */}
        {conflicts.length > 0 && (
          <div className="space-y-2">
            {conflicts.map(conflict => (
              <div key={conflict.id} className={`p-4 rounded-md flex items-start gap-3 ${conflict.severity === 'high' ? 'bg-red-100 text-red-800 border-l-4 border-red-500' : 'bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500'}`}>
                <AlertTriangle className="h-5 w-5 mt-0.5 shrink-0" />
                <div>
                  <h4 className="font-bold">{conflict.severity === 'high' ? 'Critical Conflict' : 'Resource Warning'}</h4>
                  <p className="text-sm">{conflict.message}</p>
                </div>
              </div>
            ))}
          </div>
        )}

        {/* View: Gantt Chart */}
        {view === 'gantt' && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-4">
            <h2 className="text-xl font-bold mb-6 text-slate-800">Production Schedule</h2>
            
            <div className="overflow-x-auto">
              <div className="min-w-[800px]">
                {/* Time Axis (Simplified) */}
                <div className="flex border-b border-slate-200 pb-2 mb-4 text-xs text-slate-400">
                  <div className="w-1/4">Dish</div>
                  <div className="w-3/4 flex justify-between px-2">
                    <span>Start Prep</span>
                    <span className="text-center">Cooking</span>
                    <span className="text-right">Dinner ({dinnerTimeStr})</span>
                  </div>
                </div>

                <div className="space-y-6">
                  {scheduleData.sortedDishes.map((dish) => {
                    // Calculate percentages for width
                    const totalProjectMinutes = scheduleData.range; 
                    // Offset from start of entire project
                    const startOffset = dish.times.start - scheduleData.earliestStart;
                    
                    const leftPct = (startOffset / totalProjectMinutes) * 75; // 75% of width used for bars
                    const prepWidth = (dish.prepMinutes / totalProjectMinutes) * 75;
                    const cookWidth = (dish.cookMinutes / totalProjectMinutes) * 75;
                    const restWidth = (dish.restMinutes / totalProjectMinutes) * 75;

                    return (
                      <div key={dish.id} className="group">
                        <div className="flex items-center mb-1">
                          <div className="w-1/4 pr-4">
                            <div className="font-bold text-slate-800">{dish.name}</div>
                            <div className="text-xs text-slate-500 flex gap-2">
                              <span>{dish.resource} {dish.resource === 'Oven' && `@ ${dish.temp}Â°F`}</span>
                            </div>
                          </div>
                          <div className="w-3/4 relative h-8 bg-slate-100 rounded-full flex overflow-hidden">
                            {/* Spacer */}
                            <div style={{ width: `${leftPct}%` }} className="h-full bg-transparent shrink-0"></div>
                            
                            {/* Prep Block */}
                            {dish.prepMinutes > 0 && (
                              <div style={{ width: `${prepWidth}%` }} className="h-full bg-blue-400 shrink-0 flex items-center justify-center group/item relative cursor-help">
                                <span className="text-[10px] text-white font-bold truncate px-1">Prep</span>
                                <div className="absolute bottom-full mb-1 hidden group-hover/item:block bg-slate-800 text-white text-xs p-1 rounded z-10 whitespace-nowrap">
                                  {minutesToTime(dish.times.start)} - Prep ({dish.prepMinutes}m)
                                </div>
                              </div>
                            )}

                            {/* Cook Block */}
                            {dish.cookMinutes > 0 && (
                              <div style={{ width: `${cookWidth}%` }} className={`h-full ${dish.resource === 'Oven' ? 'bg-orange-500' : 'bg-red-500'} shrink-0 flex items-center justify-center group/item relative cursor-help`}>
                                <span className="text-[10px] text-white font-bold truncate px-1">Cook</span>
                                <div className="absolute bottom-full mb-1 hidden group-hover/item:block bg-slate-800 text-white text-xs p-1 rounded z-10 whitespace-nowrap">
                                  {minutesToTime(dish.times.cook)} - Cook ({dish.cookMinutes}m)
                                </div>
                              </div>
                            )}

                            {/* Rest Block */}
                            {dish.restMinutes > 0 && (
                              <div style={{ width: `${restWidth}%` }} className="h-full bg-emerald-400 shrink-0 flex items-center justify-center group/item relative cursor-help">
                                <span className="text-[10px] text-white font-bold truncate px-1">Rest</span>
                                <div className="absolute bottom-full mb-1 hidden group-hover/item:block bg-slate-800 text-white text-xs p-1 rounded z-10 whitespace-nowrap">
                                  {minutesToTime(dish.times.rest)} - Rest ({dish.restMinutes}m)
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                        <div className="w-full flex justify-end text-xs text-slate-400 border-b border-slate-100 pb-2">
                          Start at: <span className="font-mono text-slate-600 ml-1">{minutesToTime(dish.times.start)}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
                
                {/* Legend */}
                <div className="mt-8 flex gap-4 text-xs justify-end text-slate-500">
                   <div className="flex items-center gap-1"><div className="w-3 h-3 bg-blue-400 rounded"></div>Prep</div>
                   <div className="flex items-center gap-1"><div className="w-3 h-3 bg-orange-500 rounded"></div>Cook (Oven)</div>
                   <div className="flex items-center gap-1"><div className="w-3 h-3 bg-red-500 rounded"></div>Cook (Other)</div>
                   <div className="flex items-center gap-1"><div className="w-3 h-3 bg-emerald-400 rounded"></div>Rest</div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* View: Run Sheet */}
        {view === 'list' && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 className="text-xl font-bold mb-6 text-slate-800 flex items-center gap-2">
              <Clock className="w-6 h-6 text-orange-600" />
              Master Run Sheet
            </h2>
            <div className="relative border-l-2 border-slate-200 ml-3 space-y-8 pb-4">
              {runSheet.map((item, idx) => (
                <div key={idx} className="relative pl-8 group">
                  <div className={`absolute -left-[9px] top-0 w-4 h-4 rounded-full border-2 border-white ${
                    item.type === 'serve' ? 'bg-orange-600 w-5 h-5 -left-[11px]' :
                    item.type === 'prep' ? 'bg-blue-400' :
                    item.type === 'rest' ? 'bg-emerald-400' : 'bg-red-500'
                  }`}></div>
                  
                  <div className="flex flex-col sm:flex-row sm:items-baseline gap-2">
                    <span className="font-mono font-bold text-lg text-slate-700 min-w-[100px]">{minutesToTime(item.time)}</span>
                    <div className="flex-1">
                      <span className={`font-bold text-lg ${item.type === 'serve' ? 'text-orange-700 uppercase tracking-widest' : 'text-slate-800'}`}>
                        {item.action}
                      </span>
                      {item.type !== 'serve' && (
                         <div className="text-sm text-slate-500 mt-1">
                           Target: {item.dishName}
                         </div>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* View: Input Management */}
        {view === 'input' && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {/* Add Form */}
            <div className="md:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-fit">
              <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Plus className="w-5 h-5" /> Add New Dish
              </h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Dish Name</label>
                  <input 
                    type="text" 
                    value={newDish.name} 
                    onChange={e => setNewDish({...newDish, name: e.target.value})}
                    placeholder="e.g. Cornbread"
                    className="w-full border border-slate-300 rounded p-2 focus:ring-2 focus:ring-orange-200 outline-none"
                  />
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                     <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Prep (min)</label>
                     <input 
                      type="number" 
                      value={newDish.prepMinutes} 
                      onChange={e => setNewDish({...newDish, prepMinutes: parseInt(e.target.value) || 0})}
                      className="w-full border border-slate-300 rounded p-2"
                    />
                  </div>
                  <div>
                     <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Cook (min)</label>
                     <input 
                      type="number" 
                      value={newDish.cookMinutes} 
                      onChange={e => setNewDish({...newDish, cookMinutes: parseInt(e.target.value) || 0})}
                      className="w-full border border-slate-300 rounded p-2"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                     <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Rest (min)</label>
                     <input 
                      type="number" 
                      value={newDish.restMinutes} 
                      onChange={e => setNewDish({...newDish, restMinutes: parseInt(e.target.value) || 0})}
                      className="w-full border border-slate-300 rounded p-2"
                    />
                  </div>
                  <div>
                     <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Resource</label>
                     <select 
                      value={newDish.resource} 
                      onChange={e => setNewDish({...newDish, resource: e.target.value})}
                      className="w-full border border-slate-300 rounded p-2 bg-white"
                    >
                      {RESOURCES.map(r => <option key={r} value={r}>{r}</option>)}
                    </select>
                  </div>
                </div>

                {newDish.resource === 'Oven' && (
                  <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Oven Temp (Â°F)</label>
                     <input 
                      type="number" 
                      value={newDish.temp} 
                      step="25"
                      onChange={e => setNewDish({...newDish, temp: parseInt(e.target.value) || 0})}
                      className="w-full border border-slate-300 rounded p-2"
                    />
                  </div>
                )}

                <button 
                  onClick={addDish}
                  className="w-full bg-orange-600 text-white font-bold py-3 rounded hover:bg-orange-700 transition-colors flex justify-center items-center gap-2 mt-2"
                >
                  Add to Plan
                </button>
              </div>
            </div>

            {/* List */}
            <div className="md:col-span-2 space-y-4">
              {dishes.map(dish => (
                <div key={dish.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group">
                  <div>
                    <h4 className="font-bold text-lg text-slate-800">{dish.name}</h4>
                    <div className="text-sm text-slate-500 mt-1 flex gap-4">
                      <span className="flex items-center gap-1"><Utensils className="w-3 h-3" /> {dish.resource} {dish.resource === 'Oven' && `(${dish.temp}Â°F)`}</span>
                      <span>Prep: {dish.prepMinutes}m</span>
                      <span>Cook: {dish.cookMinutes}m</span>
                      <span>Rest: {dish.restMinutes}m</span>
                    </div>
                  </div>
                  <button 
                    onClick={() => removeDish(dish.id)}
                    className="text-slate-300 hover:text-red-500 transition-colors p-2"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                </div>
              ))}
              {dishes.length === 0 && (
                <div className="text-center py-12 text-slate-400 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300">
                  <p>No dishes planned yet.</p>
                </div>
              )}
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
